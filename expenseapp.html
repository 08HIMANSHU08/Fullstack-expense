<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <title>Expense App</title>
  </head>
  <body>
    <section class="container container-sm container-md container-lg container-xl container-xxl">
      <div class="container h-100">
        <div class="row h-100 justify-content-center">
          <div class="col-10 col-md-8 col-lg-6">
            <form id="my-form" class="form-control">
              <div class="form-group">
                <label for="expense" class="text-danger text-center">Choose Expense Amount:</label>
                <input type="number" id="expense" class="form-control">
              </div>
              <div class="form-group">
                <label for="description" class="text-danger">Choose Description:</label>
                <textarea type="textarea" id="description"class="form-control"></textarea>
              </div>
              <div class="form-group">
                <label for="category" class="text-danger">Choose a Category:</label>
                <select id="category" class="form-control">
                  <option value="" selected disabled >Select Category</option>
                  <option value="Fuel">Fuel</option>
                  <option value="Movie">Movie</option>
                  <option value="Groceries">Groceries</option>
                  <option value="Electricity">Electricity</option>
                  <option value="Rent">Rent</option>
                  <option value="Travel">Travel</option>
                  <option value="Internet">Internet</option>
                  <option value="Pet">Pet</option>
                  <option value="Shopping">Shopping</option>
                </select>
              </div>
              <div class="d-flex justify-content-center">
                <buttton class="btn btn-primary btn-sm btn-outline-dark m-2 btn-c" id="submitform">Add Expense</buttton>
              </div> 
          </form>
          <div class="d-flex justify-content-center" id="premium">
            <button id="razorpayBuy" class="btn btn-info btn-sm btn-outline-dark m-2 btn-c">Buy Premium</button>
            <h6 id="message"></h6>
            <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
          </div> 
          </div>
        </div>
      </div>
    </br>
      <div class="container h-100">
        <div class="row h-100 justify-content-center">
          <div class="col-10 col-md-8 col-lg-6">
            <ul id="listofexpense" class="list-group">
            </ul>
            <ul id="leaderboardlist" class="list-group">
            </ul>
          </div>
        </div>
      </div>
    </section> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    <script>
        const myForm = document.querySelector('#my-form');
        const expenseInput = document.querySelector('#expense');
        const descriptionInput = document.querySelector('#description');
        const categoryInput = document.querySelector('#category');
        const listOfExpense = document.querySelector('#listofexpense');
           
        document.getElementById("submitform").onclick= function(e){
          e.preventDefault();       
          const li = document.createElement('li');
          const exp=expenseInput.value;
          const desc=descriptionInput.value;
          const cat=categoryInput.value;
          const inputData={
            exp,
            cat,
            desc
          };
          const token = localStorage.getItem('token');
          axios.post("http://localhost:3000/expense/add-expense",inputData,{headers:{"Authorization":token}})
            .then((response)=>{
              console.log(response);
              showuser(response.data.newExpense);
            })
            .catch((err)=>{
              console.log(err);
            })
            expenseInput.value = '';
            descriptionInput.value='';
            categoryInput.value = '';  
        }
       

        function parseJwt (token) {
          var base64Url = token.split('.')[1];
          var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
          }).join(''));
           return JSON.parse(jsonPayload);
        }

        function showPremiumFeature(){
          document.getElementById("razorpayBuy").style.visibility="hidden";
          document.getElementById("message").innerHTML="Premium User";
          
        }

        function showleaderBoard(){
          const leaderBoard = document.createElement("input");
          leaderBoard.className="btn btn-sm btn-outline-dark float-end";
          leaderBoard.type="button";
          leaderBoard.value="Show LeaderBoard";
          leaderBoard.onclick= async ()=>{
            const token = localStorage.getItem('token');
            const userLeaderBoardArray = await axios.get('http://localhost:3000/premium/show-leaderboard',{headers:{"Authorization":token}})
            console.log(userLeaderBoardArray);
            let leaderBoardElement = document.getElementById('leaderboardlist');
            leaderBoardElement.innerHTML+="<h1>Leader Board</h1>";
            userLeaderBoardArray.data.forEach((userDetails)=>{
              leaderBoardElement.innerHTML+=`<li>Name= ${userDetails.name} total Expense= ${userDetails.total_expense}`;
            })
          }
          document.getElementById('message').appendChild(leaderBoard)
        }

        window.addEventListener("DOMContentLoaded",()=>{
          const token = localStorage.getItem('token');
          const decodeToken = parseJwt(token);
          console.log(decodeToken);
          if(decodeToken.ispremiumuser==true)
          {
            showPremiumFeature();
            showleaderBoard();
          }
          axios.get(`http://localhost:3000/expense/get-expense`,{headers:{"Authorization":token}})
            .then((response)=>{
             response.data.allExpense.forEach(expense=>{
                showuser(expense);
              })
              })
              .catch((err)=>{console.error(err)});
        });

        function showuser(obj){

          const parentitem=document.getElementById("listofexpense");
          const childitem=document.createElement("li");
          childitem.className="list-group-item"
          childitem.textContent=obj.amount+" - "+obj.category+" - "+obj.description;

          const deleteitem =document.createElement("input");
          deleteitem.className="btn btn-danger btn-sm btn-outline-dark float-end";
          deleteitem.type="button";
          deleteitem.value="Delete Expense";

          deleteitem.onclick=()=>{
            const token = localStorage.getItem('token');
            axios.delete(`http://localhost:3000/expense/delete-expense/${obj.id}`,{headers:{"Authorization":token}})
            .then((response)=>{
                console.log(response);
            })
            .catch((err)=>{
                console.log(err)
            });
              parentitem.removeChild(childitem);
          }
         
          childitem.appendChild(deleteitem);
          parentitem.appendChild(childitem);
        }

        document.getElementById("razorpayBuy").onclick= async function(e){
          e.preventDefault();
          const token = localStorage.getItem('token');
          await axios.get("http://localhost:3000/purchase/buypremiummembership",{headers:{"Authorization":token}})
          .then((response)=>{
            console.log("res",response);
              var options={
              "key":response.data.key_id,
              "order_id":response.data.order.id,
              "handler":async function(response){
                const res=await axios.post("http://localhost:3000/purchase/updatetransactionstatus",{
                  order_id:options.order_id,
                  payment_id:response.razorpay_payment_id,
                },{headers:{"Authorization":token}})
                alert("you are now a Premium User")
                showPremiumFeature();
                showleaderBoard();
                localStorage.setItem("token",res.data.token);
              }
            }
            const rzpl = new Razorpay(options);
            rzpl.open();
            e.preventDefault();
            rzpl.on('payment.failed', function(response){
              console.log(response);
              alert("Something Went Wrong With payment Please Try Again");
            })
          })
          .catch(err=>{console.log(err)});
        }
    </script>
  </body>
</html>